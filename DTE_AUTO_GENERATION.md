# DTE Auto-Generation Feature

Automatic and manual generation of electronic tax documents (Boletas/Facturas) based on payment method and order source.

---

## Overview

The system automatically or manually generates DTEs (Documentos Tributarios Electrónicos) based on these rules:

| Payment Method | Source | Action |
|---|---|---|
| **Transbank (Webpay)** | Website | ❌ NO document created |
| **Bank Transfer** | Website | ✅ AUTO-generate Boleta |
| **Bank Transfer** | Manual (Admin) | ⚠️ MANUAL selection (Factura or Boleta) |

---

## Implementation Details

### 1. Auto-Generation (Website Bank Transfer)

When a bank transfer payment is confirmed from the website, a **Boleta Electrónica (39)** is automatically generated.

**Endpoint:** `POST /api/payment/confirm-transfer/:order_id`

**Request Body:**
```json
{
  "confirmation_notes": "Transferencia confirmada",
  "source": "website"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Pago por transferencia confirmado",
  "order": {
    "order_id": "SA-2026-001",
    "status": "confirmed",
    "confirmed_at": "2026-01-07T12:00:00Z"
  },
  "dte": {
    "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "tipoDTE": 39,
    "status": "pending",
    "message": "Boleta Electrónica auto-generada"
  }
}
```

### 2. Manual Selection (Admin Orders)

When adding orders manually and confirming them, the admin can select the document type.

**Option A: During Status Update**

**Endpoint:** `PUT /api/payment/status/:order_id`

**Request Body:**
```json
{
  "status": "confirmed",
  "notes": "Orden confirmada manualmente",
  "dte_type": "factura"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Estado actualizado a: confirmed",
  "order": {
    "order_id": "SA-2026-002",
    "status": "confirmed",
    "previous_status": "initiated"
  },
  "dte": {
    "uuid": "b2c3d4e5-f6f7-8901-bcde-f12345678901",
    "tipoDTE": 33,
    "status": "pending",
    "message": "Factura Electrónica generada"
  }
}
```

**Option B: Dedicated DTE Generation Endpoint**

**Endpoint:** `POST /api/payment/generate-dte/:order_id`

**Request Body:**
```json
{
  "dte_type": "boleta"
}
```

**Parameters:**
- `dte_type` - "factura" (33) or "boleta" (39)

**Response:**
```json
{
  "success": true,
  "message": "Boleta Electrónica generada exitosamente",
  "dte": {
    "uuid": "c3d4e5f6-g7h8-9012-cdef-g12345678902",
    "tipoDTE": 39,
    "status": "pending",
    "type": "boleta"
  }
}
```

### 3. No Document (Transbank)

Transbank (Webpay) payments do NOT generate DTEs automatically. The system skips DTE generation for these orders.

---

## Database Fields

Orders now include DTE tracking fields:

```javascript
{
  buy_order: String,
  payment_method: String, // 'webpay', 'transferencia'
  status: String,
  dte_uuid: String, // UUID of generated DTE
  dte_type: String, // 'factura' or 'boleta'
  // ... other fields
}
```

---

## Helper Functions

### generateDTE(order, tipoDTE)
Generates a DTE document for an order with specified type.

**Parameters:**
- `order` - Order object
- `tipoDTE` - 33 (Factura) or 39 (Boleta)

**Returns:** DTE object with uuid, tipoDTE, status

### autoGenerateDTE(order, source)
Auto-generates boleta if conditions are met (bank transfer + website).

**Parameters:**
- `order` - Order object
- `source` - 'website' or 'manual'

**Returns:** DTE object or null

### generateManualDTE(order, dteType)
Generates DTE with manual type selection.

**Parameters:**
- `order` - Order object
- `dteType` - 'factura' or 'boleta'

**Returns:** DTE object or null

---

## Frontend Integration

### React Hook Example

```javascript
import { useState } from 'react';

export function useDTEGeneration(token) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const confirmTransferPayment = async (orderId, source = 'website') => {
    setLoading(true);
    try {
      const response = await fetch(
        `https://api.sirizagaria.com/api/payment/confirm-transfer/${orderId}`,
        {
          method: 'POST',
          headers: {
            'x-auth-token': token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            confirmation_notes: 'Transferencia confirmada',
            source
          })
        }
      );
      const data = await response.json();
      return data;
    } catch (err) {
      setError(err.message);
      return { success: false, error: err.message };
    } finally {
      setLoading(false);
    }
  };

  const generateDTE = async (orderId, dteType) => {
    setLoading(true);
    try {
      const response = await fetch(
        `https://api.sirizagaria.com/api/payment/generate-dte/${orderId}`,
        {
          method: 'POST',
          headers: {
            'x-auth-token': token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ dte_type: dteType })
        }
      );
      const data = await response.json();
      return data;
    } catch (err) {
      setError(err.message);
      return { success: false, error: err.message };
    } finally {
      setLoading(false);
    }
  };

  return {
    loading,
    error,
    confirmTransferPayment,
    generateDTE
  };
}
```

### Component Example

```javascript
import React, { useState } from 'react';
import { useDTEGeneration } from '../hooks/useDTEGeneration';

export function OrderConfirmation({ orderId, token }) {
  const { confirmTransferPayment, generateDTE } = useDTEGeneration(token);
  const [selectedDTE, setSelectedDTE] = useState(null);

  const handleConfirmTransfer = async () => {
    const result = await confirmTransferPayment(orderId, 'website');
    if (result.success) {
      console.log('Transfer confirmed and DTE auto-generated:', result.dte);
    }
  };

  const handleGenerateDTE = async (dteType) => {
    const result = await generateDTE(orderId, dteType);
    if (result.success) {
      setSelectedDTE(result.dte);
      console.log('DTE generated:', result.dte);
    }
  };

  return (
    <div className="order-confirmation">
      <h2>Confirm Order</h2>

      <button onClick={handleConfirmTransfer}>
        Confirm Bank Transfer (Auto-generates Boleta)
      </button>

      <div className="dte-selection">
        <h3>Or Select Document Type</h3>
        <button onClick={() => handleGenerateDTE('factura')}>
          Generate Factura
        </button>
        <button onClick={() => handleGenerateDTE('boleta')}>
          Generate Boleta
        </button>
      </div>

      {selectedDTE && (
        <div className="dte-info">
          <p>Document UUID: {selectedDTE.uuid}</p>
          <p>Type: {selectedDTE.type}</p>
          <p>Status: {selectedDTE.status}</p>
        </div>
      )}
    </div>
  );
}
```

---

## Business Rules

1. **Transbank Orders**: No DTE generated automatically
2. **Website Bank Transfers**: Boleta auto-generated on confirmation
3. **Manual Orders**: Admin selects Factura or Boleta when confirming
4. **One DTE per Order**: Cannot generate multiple DTEs for same order
5. **Confirmed Orders Only**: DTEs can only be generated for confirmed orders
6. **Automatic Linking**: DTEs automatically link to customers by email/name

---

## Error Handling

### Order Not Found
```json
{
  "success": false,
  "error": "Orden no encontrada"
}
```

### Invalid DTE Type
```json
{
  "success": false,
  "error": "Tipo de documento inválido. Use \"factura\" o \"boleta\""
}
```

### Order Not Confirmed
```json
{
  "success": false,
  "error": "Solo se pueden generar documentos para órdenes confirmadas"
}
```

### DTE Already Exists
```json
{
  "success": false,
  "error": "Esta orden ya tiene un documento tributario generado",
  "dte": {
    "uuid": "existing-uuid",
    "type": "boleta"
  }
}
```

---

## API Endpoints Summary

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/payment/confirm-transfer/:order_id` | Confirm transfer (auto-generates boleta if from website) |
| PUT | `/api/payment/status/:order_id` | Update order status (with optional dte_type) |
| POST | `/api/payment/generate-dte/:order_id` | Manually generate DTE with selected type |

---

## Testing

### Test Auto-Generation (Website)
```bash
curl -X POST https://api.sirizagaria.com/api/payment/confirm-transfer/SA-2026-001 \
  -H "x-auth-token: YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "confirmation_notes": "Transferencia confirmada",
    "source": "website"
  }'
```

### Test Manual Selection (Admin)
```bash
curl -X POST https://api.sirizagaria.com/api/payment/generate-dte/SA-2026-002 \
  -H "x-auth-token: YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "dte_type": "factura"
  }'
```

---

## Summary

✅ **Transbank**: No DTE generated
✅ **Website Bank Transfer**: Auto-generates Boleta
✅ **Manual Orders**: Admin selects Factura or Boleta
✅ **Automatic Linking**: DTEs link to customers
✅ **Error Handling**: Comprehensive validation
✅ **Frontend Ready**: React hooks and components provided
